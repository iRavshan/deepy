{% extends '../shared/_blank.html' %}
{% load static %}
{% block title %} Speed Run Game {% endblock %}
{% block content %}
<div class="app-container">
    
    <!-- Header: Score & Music -->
    <button class="header-btn btn-exit" onclick="window.location.href='{% url 'speed_run_setup' %}'">
        <i class="fa-solid fa-xmark"></i> Yakunlash
    </button>

    <div class="score-board">
        <span><i class="fa-solid fa-gem"></i></span> <span id="scoreDisplay">0</span>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen active">
        
        <!-- Timer (Only visible for Timed Mode) -->
        <div class="timer-track" id="timerTrack" style="opacity: 0;">
            <div class="timer-bar" id="timerBar"></div>
        </div>
        
        <!-- Progress (Only visible for Survival Mode) -->
        <div class="progress-track" id="progressTrack" style="opacity: 0;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="card-scene" onclick="flipCard()">
            <div class="card" id="cardObj">
                <div class="card-face card-front">
                    <div id="txtFront">Yuklanmoqda...</div>
                </div>
                <div class="card-face card-back">
                    <div id="txtBack">...</div>
                </div>
            </div>
        </div>

        <button class="btn btn-blue" id="btnFlip" onclick="flipCard()">Javobni ko'rsatish</button>

        <div class="feedback-grid hidden" id="feedbackArea">
            <button class="btn btn-red" onclick="handleResult(false)">
                <i class="fa-solid fa-xmark"></i> Noto'g'ri
            </button>
            <button class="btn btn-correct" onclick="handleResult(true)">
                <i class="fa-solid fa-check"></i> To'g'ri
            </button>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="resultScreen" class="screen">
        <h1 id="resultTitle">O'yin tugadi!</h1>
        
        <div class="final-score-box">
            <h2 class="big-score"><i class="fa-solid fa-gem"></i><span id="finalScore">0</span></h2>
            <p>Jami ochkolar</p>
        </div>

        <div class="stats-grid">
            <div class="stat-box correct">
                <i class="fa-solid fa-check"></i>
                <span id="countCorrect">0</span>
                <label>To'g'ri</label>
            </div>
            <div class="stat-box incorrect">
                <i class="fa-solid fa-xmark"></i>
                <span id="countIncorrect">0</span>
                <label>Noto'g'ri</label>
            </div>
            <div class="stat-box skipped">
                <i class="fa-solid fa-forward"></i>
                <span id="countSkipped">0</span>
                <label>Javob berilmadi</label>
            </div>
        </div>

        <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top: 30px;">Yana boshlash</button>
        <button class="btn btn-secondary" onclick="window.location.href='{% url 'speed_run_setup' %}'" style="margin-top: 10px;">Yangi o'yin</button>
    </div>

</div>

<style>
    /* Styling */
    body {
        margin: 0; padding: 0;
        font-family: 'Nunito', sans-serif;
        background-color: var(--bg-app);
        display: flex; justify-content: center; align-items: center;
        min-height: 100vh;
    }

    .app-container {
        width: 100%; max-width: 500px;
        padding: 80px 20px 20px 20px;
        background: var(--bg-panel);
        min-height: 100vh;
        display: flex; flex-direction: column; align-items: center;
        position: relative;
    }

    /* Header */
    .header-btn, .score-board {
        position: absolute; top: 20px;
        background: var(--bg-app);
        border: 2px solid var(--border-color);
        padding: 8px 16px; border-radius: 20px;
        font-weight: 800; display: flex; align-items: center; gap: 8px;
        box-shadow: 0 4px 0 var(--border-color);
        color: var(--text-medium);
        cursor: pointer;
        font-family: var(--secondary-font);
    }
    .header-btn { left: 20px; transition: all 0.2s; }
    .header-btn:hover { color: var(--theme-red); border-color: var(--theme-red); }
    
    .score-board { right: 20px; color: var(--theme-blue); border-color: var(--theme-blue-light); }

    /* Game Screen */
    .screen { width: 100%; display: none; flex-direction: column; align-items: center; animation: fadeIn 0.5s; }
    .screen.active { display: flex; }

    /* Bars */
    .timer-track, .progress-track {
        width: 100%; height: 16px; background: var(--border-color);
        border-radius: 8px; margin-bottom: 30px; overflow: hidden; position: relative;
    }
    .timer-bar {
        height: 100%; width: 100%; background: var(--theme-pink); border-radius: 8px;
        transition: width 1s linear;
    }
    .progress-bar {
        height: 100%; width: 0%; background: var(--theme-blue); border-radius: 8px;
        transition: width 0.3s ease;
    }

    /* Card */
    .card-scene { perspective: 1000px; width: 100%; height: 350px; margin-bottom: 25px; }
    .card {
        width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: var(--card-radius); cursor: pointer;
        box-shadow: 0 10px 0 rgba(0,0,0,0.1);
    }
    .card.flipped { transform: rotateY(180deg); }

    .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        background: var(--bg-panel); border: 2px solid var(--border-color);
        border-radius: var(--card-radius); padding: 30px; text-align: center;
        font-size: 1.8rem; font-weight: 800; color: var(--text-dark);
    }
    .card-back { transform: rotateY(180deg); background: #fff5f8; border-color: var(--theme-pink); }

    /* Buttons */
    .btn {
        width: 100%; padding: 18px; border-radius: var(--btn-radius); border: none;
        font-size: 1.2rem; font-weight: 900; color: white; cursor: pointer;
        box-shadow: 0 6px 0 rgba(0,0,0,0.1); margin-bottom: 10px;
        transition: all 0.2s;
        font-family: var(--secondary-font);
    }
    .btn:active { transform: translateY(4px); box-shadow: none; margin-bottom: 14px; }
    
    .btn-blue { background: var(--theme-blue); box-shadow: 0 6px 0 var(--theme-blue-dark); }
    .btn-red { background: var(--theme-red); box-shadow: 0 6px 0 var(--theme-red-dark); }
    .btn-correct { background: var(--theme-green); box-shadow: 0 6px 0 var(--theme-green-dark); }
    .btn-primary { background: var(--theme-pink); box-shadow: 0 6px 0 var(--theme-pink-dark); }
    .btn-secondary { background: var(--theme-gray); color: var(--text-dark); box-shadow: 0 6px 0 #ccc; }

    .feedback-grid { display: flex; gap: 15px; width: 100%; }
    .hidden { display: none !important; }

    /* Results */
    .final-score-box { text-align: center; margin-bottom: 40px; }
    .big-score { font-size: 4rem; margin: 0; color: var(--theme-pink); }
    
    .stats-grid { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
    .stat-box {
        flex: 1; padding: 15px; border-radius: 15px; text-align: center;
        border: 2px solid var(--border-color);
        display: flex; flex-direction: column; align-items: center; gap: 5px;
    }
    .stat-box i { font-size: 1.5rem; margin-bottom: 5px; }
    .stat-box span { font-size: 1.5rem; font-weight: 900; }
    .stat-box label { font-size: 0.8rem; font-weight: 700; color: var(--text-medium); }
    
    .stat-box.correct { color: var(--theme-green); border-color: var(--theme-green-light); background: var(--theme-green-light); }
    .stat-box.incorrect { color: var(--theme-red); border-color: var(--theme-red-light); background: var(--theme-red-light); }
    .stat-box.skipped { color: var(--text-medium); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Game Config ---
        const terms = {{ terms_json|safe }};
        const startSide = "{{ start_side }}"; // 'term' or 'definition'
        const mode = "{{ mode }}"; // 'survival' or 'timed'
        let duration = parseInt("{{ duration }}");
        const totalCount = {{ total_count }};
        
        // --- State ---
        let currentIndex = 0;
        let score = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let gameTimer;
        let isGameActive = true;

        // --- Elements ---
        const cardObj = document.getElementById('cardObj');
        const txtFront = document.getElementById('txtFront');
        const txtBack = document.getElementById('txtBack');
        const btnFlip = document.getElementById('btnFlip');
        const feedbackArea = document.getElementById('feedbackArea');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timerTrack = document.getElementById('timerTrack');
        const timerBar = document.getElementById('timerBar');
        const progressTrack = document.getElementById('progressTrack');
        const progressBar = document.getElementById('progressBar');

        // --- Init ---
        if (mode === 'timed') {
            timerTrack.style.opacity = '1';
            startTimer();
        } else {
            progressTrack.style.opacity = '1';
        }

        if (terms.length === 0) {
            alert("No terms found for these topics!");
            window.location.href = "{% url 'speed_run_setup' %}";
            return;
        }

        renderCard();

        // --- Logic ---
        window.flipCard = function() {
            if (!isGameActive || cardObj.classList.contains('flipped')) return;
            cardObj.classList.add('flipped');
            btnFlip.classList.add('hidden');
            feedbackArea.classList.remove('hidden');
        };

        window.handleResult = function(isCorrect) {
            if (!isGameActive) return;

            if (isCorrect) {
                score += 10;
                correctCount++;
                // Bonus for speed? Maybe later
            } else {
                incorrectCount++;
            }
            updateUI();
            nextCard();
        };

        function nextCard() {
            currentIndex++;
            
            // Check End Conditions
            if (mode === 'survival' && currentIndex >= terms.length) {
                endGame(true);
                return;
            }
            // For timed mode, we loop or just stop if out of terms? 
            // Let's loop if we run out of terms in timed mode
            if (mode === 'timed' && currentIndex >= terms.length) {
                currentIndex = 0; // Loop deck
            }

            renderCard();
        }

        function renderCard() {
            // Reset Card State
            cardObj.classList.remove('flipped');
            btnFlip.classList.remove('hidden');
            feedbackArea.classList.add('hidden');
            
            // Wait small delay for flip back animation if needed, 
            // but for speed run instant is better for flow.
            // However, we need to swap text while hidden/flipping? 
            // Let's just update content immediately for snap feel
            
            const term = terms[currentIndex];
            if (startSide === 'term') {
                txtFront.textContent = term.term;
                txtBack.textContent = term.definition;
            } else {
                txtFront.textContent = term.definition;
                txtBack.textContent = term.term;
            }
            
            // Update Progress Bar
            if (mode === 'survival') {
                const pct = (currentIndex / totalCount) * 100;
                progressBar.style.width = `${pct}%`;
            }
        }

        function updateUI() {
            scoreDisplay.textContent = score;
        }

        function startTimer() {
            const startTime = Date.now();
            const endTime = startTime + (duration * 1000);
            
            gameTimer = setInterval(() => {
                const now = Date.now();
                const remaining = endTime - now;
                
                if (remaining <= 0) {
                    timerBar.style.width = '0%';
                    endGame(false);
                } else {
                    const pct = (remaining / (duration * 1000)) * 100;
                    timerBar.style.width = `${pct}%`;
                }
            }, 100);
        }

        function endGame(completed) {
            isGameActive = false;
            clearInterval(gameTimer);
            
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('resultScreen').classList.add('active');
            
            const title = document.getElementById('resultTitle');
            if (completed) {
                title.textContent = "Challenge Complete!";
                title.style.color = "var(--theme-green)";
            } else {
                title.textContent = "Vaqt tugadi!";
                title.style.color = "var(--theme-pink)";
            }
            
            // Stats
            document.getElementById('finalScore').textContent = score;
            document.getElementById('countCorrect').textContent = correctCount;
            document.getElementById('countIncorrect').textContent = incorrectCount;
            
            // Unanswered: Total available - (correct + incorrect) 
            // Only valid for survival really. In timed mode, unanswered is infinite?
            // Let's show skipped as (total deck - answered) if survival
            let answered = correctCount + incorrectCount;
            let skipped = 0;
            if (mode === 'survival') {
                skipped = totalCount - answered;
            }
            document.getElementById('countSkipped').textContent = skipped;
        }
    });
</script>
{% endblock content %}

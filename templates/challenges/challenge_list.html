{% extends '../shared/_base.html' %}
{% block title %} Masalalar {% endblock %}
{% block content %}
{% load static %}
{% load i18n %}
<main class="container">
    <form action="." method="GET">
        <div class="page-header-row">
            <h1 class="page-title">Masalalar</h1>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="search" name="q" class="search-input" placeholder="Qidirish..." value="{{ search_query }}">
            </div>
        </div>
        <div class="problem-list">
            <div class="problems" id="challenge-container">
                {% for challenge in challenges%}
                {% include 'challenges/includes/challenge_card.html' %}
                {% empty %}
                <p>Masalalar topilmadi</p>
                {% endfor %}
                <div id="loading-spinner" style="display: none; text-align: center; width: 100%; padding: 20px;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--theme-blue);"></i>
                </div>
            </div>
            <div class="sidebar">
                <div class="filter-group">
                    <div class="filter-header">Qiyinlik darajasi</div>
                    <label class="filter-option">
                        <input type="checkbox" name="difficulty" value="easy" onchange="this.form.submit()" {% if 'easy' in selected_difficulties %}checked{% endif %}>
                        <div class="checkbox-visual"></div>
                        Oson
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="difficulty" value="medium" onchange="this.form.submit()" {% if 'medium' in selected_difficulties %}checked{% endif %}>
                        <div class="checkbox-visual"></div>
                        O'rta
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="difficulty" value="hard" onchange="this.form.submit()" {% if 'hard' in selected_difficulties %}checked{% endif %}>
                        <div class="checkbox-visual"></div>
                        Qiyin
                    </label>
                </div>

                <div class="filter-group">
                    <div class="filter-header">Mavzular</div>
                    {% for tag in tags %}
                    <label class="filter-option">
                        <input type="checkbox" name="tag" value="{{ tag.slug }}" onchange="this.form.submit()" {% if tag.slug in selected_tags %}checked{% endif %}>
                        <div class="checkbox-visual"></div>
                        {{ tag.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </form>
</main>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let page = 1;
        let hasNext = {{ challenges.has_next|yesno:"true,false" }};
        let isLoading = false;
        const container = document.getElementById('challenge-container');
        const spinner = document.getElementById('loading-spinner');
        
        // Infinite Scroll
        window.addEventListener('scroll', () => {
             if (isLoading || !hasNext) return;
             
             if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                 loadMoreChallenges();
             }
        });

        function loadMoreChallenges() {
            isLoading = true;
            spinner.style.display = 'block';
            page++;
            
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.html;
                
                Array.from(tempDiv.children).forEach((child, index) => {
                     // Add animation class if you have one, or just append
                     child.style.animation = `fadeInUp 0.5s ease forwards ${index * 0.1}s`;
                     child.style.opacity = '0'; // Start hidden for animation
                     container.appendChild(child);
                });
                
                hasNext = data.has_next;
            })
            .catch(console.error)
            .finally(() => {
                isLoading = false;
                spinner.style.display = 'none';
            });
        }
    });

    // Add keyframes for animation if not exists
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}